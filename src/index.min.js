const mtoDiv=()=>document.querySelector("#mto"),specialsDiv=()=>document.querySelector("#specials"),loginDiv=()=>document.querySelector("#login"),logoutDiv=()=>document.querySelector("#logout"),kartDiv=()=>document.querySelector("#kart"),containerDiv=()=>document.querySelector(".container"),pageBodyDiv=()=>document.querySelector("#pageBody"),homeLinkDiv=()=>document.querySelector("#home-link"),loginForm=()=>document.querySelector("#customer-login-form-modal"),registerForm=()=>document.querySelector("#customer-register-form-modal"),registerDiv=()=>document.querySelector("#register"),orderForm=()=>document.querySelector("#pizza-order-form"),orderQty=()=>document.querySelector("#pizza-quantity-input"),baseURL="http://localhost:3000",specialsURL=`${baseURL}/pizzas`,ingredients=`${baseURL}/ingredients`,orderURL=`${baseURL}/orders`,headerObj={"Content-Type":"application/json",Accept:"application/json"};let currentUser,todaysPrices,selectedSpecialPrice;document.addEventListener("DOMContentLoaded",()=>{mtoDiv().addEventListener("click",renderMTO),specialsDiv().addEventListener("click",renderSpecials),loginForm().addEventListener("submit",handleLogin),registerForm().addEventListener("submit",handleRegister),logoutDiv().addEventListener("click",logout),homeLinkDiv().addEventListener("click",renderHome),kartDiv().addEventListener("click",fetchKartItems),addCheckBoxes(),orderForm().addEventListener("submit",handleOrder),orderForm().addEventListener("change",updatePrice),$("#pizzaOrderModal").on("show.bs.modal",function(e){if("custom"==$(e.relatedTarget)[0].getAttribute("data-button")){orderForm().reset();let e=document.createElement("div");pageBodyDiv().appendChild(e),document.getElementById("price").innerText="7.00",orderForm().querySelectorAll(".form-check-input").forEach(e=>e.disabled=!1),orderForm().querySelectorAll(".form-control").forEach(e=>e.disabled=!1)}else orderQty().value=1,orderForm().querySelectorAll(".form-check-input").forEach(e=>e.disabled=!0),orderForm().querySelectorAll(".form-control").forEach(e=>e.disabled=!0),orderForm().querySelector("#pizza-quantity-input").disabled=!1,orderForm().querySelector("textarea").disabled=!1}),document.querySelector(".navbar-brand").appendChild(superMarioSpanGenerator("Mario Bros Pizza","tinyMario")),retrieveIngredientPrices(),renderHome()});const renderHome=()=>{inactivateNavItems(),pageBodyDiv().innerHTML="";let e=document.createElement("img");e.src="assets/welcomeMarioPizza.png",e.style.float="right",pageBodyDiv().appendChild(e)},inactivateNavItems=()=>{document.querySelectorAll(".nav-item").forEach(e=>{e.className="nav-item"})},handleLogin=e=>{e.preventDefault(),inactivateNavItems(),currentUser?logout():fetch(`${baseURL}/login`,{method:"POST",headers:headerObj,body:JSON.stringify({username:e.target.username.value})}).then(e=>e.json()).then(e=>{if(e.error)alert(e.error);else{loginForm().reset(),$("#loginModal").modal("hide"),currentUser=e,loginDiv().classList.add("d-none"),registerDiv().classList.add("d-none"),logoutDiv().classList.remove("d-none"),kartDiv().classList.remove("d-none");let t=document.createElement("span");t.className="navbar-text",t.innerText=`${currentUser.name}`,document.querySelector(".navbar").appendChild(t)}})};function logout(e){currentUser=null,registerDiv().classList.remove("d-none"),loginDiv().classList.remove("d-none"),logoutDiv().classList.add("d-none"),kartDiv().classList.add("d-none"),document.querySelector(".navbar-text").remove(),renderHome()}const handleRegister=e=>{e.preventDefault();let t=e.target.address.value+", "+e.target.city.value+", "+e.target.state.value+" "+e.target.zip.value,r={name:e.target.name.value,username:e.target.registerUsername.value,address:t};fetch(`${baseURL}/customers`,{method:"POST",headers:headerObj,body:JSON.stringify(r)}).then(e=>e.json()).then(e=>{if(e.errors){let t=Object.keys(e.errors)[0];alert(e.errors[t])}else registerForm().reset(),$("#registerModal").modal("hide"),alert(`Thank you for registering ${e.name}. Be sure to login with username "${e.username}" before you place an order!`)})},renderMTO=e=>{inactivateNavItems(),pageBodyDiv().innerHTML="",e.target.parentNode.classList.add("active")},updatePrice=e=>{if(1==orderForm().querySelector(".form-control").disabled){let e=document.getElementById("price"),t=selectedSpecialPrice;t*=parseInt(document.getElementById("pizza-quantity-input").value),e.innerText=t.toFixed(2)}else if("TEXTAREA"!=e.target.nodeName){let t=document.getElementById("price"),r=todaysPrices[1][e.currentTarget.size.value];[...document.querySelectorAll('input[type="checkbox"]:checked')].map(e=>e.dataset.category).forEach(e=>{r+=todaysPrices[0][e]});let a=document.getElementById("pizza-quantity-input").value;r*=a,t.innerText=r.toFixed(2)}};function retrieveIngredientPrices(){fetch(`${ingredients}/prices`).then(e=>e.json()).then(e=>todaysPrices=e)}function handleOrder(e){if(e.preventDefault(),currentUser){let t=[...document.querySelectorAll('input[type="checkbox"]:checked')].map(e=>parseInt(e.value)),r={quantity:parseInt(e.target.quantity.value),customer_id:currentUser.id,size:e.target.size.value,bake:e.target.bake.value,cut:e.target.cut.value,ingredients:t,delivery_instructions:e.target.deliveryInstructions.value};fetch(orderURL,{method:"POST",headers:headerObj,body:JSON.stringify(r)}).then(e=>e.json()).then(e=>{orderForm().reset(),alert(`Added ${e.quantity} pizzas to your kart.`)})}else alert("Please Log In!"),$("#loginModal").modal("toggle")}function addCheckBoxes(){let e=["veggie","cheese","sauce","meat"];fetch(ingredients).then(e=>e.json()).then(t=>{e.forEach(e=>{let r=document.querySelector(`#${e}-category`),a=t.filter(t=>t.category==e),n=document.createElement("legend");n.innerText=e.replace(e.charAt(0),e.charAt(0).toUpperCase())+"s",r.appendChild(n),a.forEach(t=>{let a=document.createElement("div"),n=document.createElement("input"),o=document.createElement("label");a.className="form-check form-check-inline",n.className="form-check-input",o.className="form-check-label",o.setAttribute("data-toggle","popover"),o.setAttribute("data-content",`<img class='hover-pic' src="${t.picture}" /><p class='hover-desc'>${t.description}</p>`),o.setAttribute("data-trigger","hover"),$(function(){$('[data-toggle="popover"]').popover({html:!0})}),n.type="checkbox",n.id=`ingredientId-${t.id}`,n.setAttribute("data-category",e),o.htmlFor=`ingredientId-${t.id}`,o.innerText=t.name,n.value=t.id,a.append(n,o),r.append(a)})})})}const renderSpecials=e=>{document.querySelector(".specials")||(inactivateNavItems(),pageBodyDiv().innerHTML="",fetch(specialsURL).then(e=>e.json()).then(e=>{pageBodyDiv().innerHTML='<div id="specialsCarousel" class="carousel slide mt-4" data-ride="carousel">\n                    <ol class="carousel-indicators">\n                        <li data-target="#specialsCarousel" data-slide-to="0" class="active"></li>\n                        <li data-target="#specialsCarousel" data-slide-to="1"></li>\n                        <li data-target="#specialsCarousel" data-slide-to="2"></li>\n                    </ol>\n                    <div class="carousel-inner">\n                    </div>\n                    <a class="carousel-control-prev" href="#specialsCarousel" role="button" data-slide="prev">\n                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>\n                        <span class="sr-only">Previous</span>\n                    </a>\n                    <a class="carousel-control-next" href="#specialsCarousel" role="button" data-slide="next">\n                        <span class="carousel-control-next-icon" aria-hidden="true"></span>\n                        <span class="sr-only">Next</span>\n                    </a>\n                    </div>',e.forEach(renderCarouselImage)}).then(()=>{e.target.parentNode.classList.add("active")}))},renderCarouselImage=e=>{let t=document.getElementById("specialsCarousel"),r=document.querySelector(".carousel-inner"),a=document.createElement("div");a.className="carousel-item";let n=document.createElement("img");n.src=e.pic;let o=document.createElement("div");o.className="carousel-caption d-none d-md-block";let i=document.createElement("p"),s=document.createElement("button");s.className="btn-dark",s.setAttribute("data-target","#pizzaOrderModal"),s.setAttribute("data-toggle","modal"),s.setAttribute("data-button","special"),specialPrice=parseFloat(e.price).toFixed(2),s.innerText=`Buy the ${e.name} for $${specialPrice}`,s.addEventListener("click",t=>{handleSpecialBuyButton(t,e)}),i.appendChild(s),o.appendChild(i),a.append(n,o),r.appendChild(a),r.querySelector(".carousel-item").classList.add("active"),t.setAttribute("data-interval",3e3)},handleSpecialBuyButton=(e,t)=>{let r=parseFloat(t.price).toFixed(2);t.ingredients.map(e=>e.id).forEach(e=>{orderForm().querySelector(`#ingredientId-${e}`).checked=!0}),selectedSpecialPrice=r,document.getElementById("price").innerText=r,document.getElementById("pizzaCutFormSelect").value=t.cut,document.getElementById("pizzaBakeFormSelect").value=t.bake,document.getElementById("pizzaSizeFormSelect").value=t.size};function fetchKartItems(e){user_id=currentUser.id,fetch(`${orderURL}/${user_id}`).then(e=>e.json()).then(t=>handleKartView(e,t))}function handleKartView(e=null,t){if(inactivateNavItems(),e&&e.target.parentNode.classList.add("active"),t.length>0){let e=t.reduce(function(e,t){return e+parseFloat(t.total_price)},0).toFixed(2);pageBodyDiv().innerHTML=`<div class="jumbotron mt-4 bg-dark text-light">\n     <h3 class="display-4">${currentUser.name}'s Kart!</h3>\n     <p class="lead">Your pizzas total to $<span id='total'>${e}</span>.</p>\n     <hr class="my-4 bg-white">\n     <ul id="kartListOfPizza"></ul>\n     <button id='checkout' class='btn btn-primary'>Checkout</button>\n   </div>`;let r=pageBodyDiv().querySelector("#kartListOfPizza");t.forEach(e=>{let t=document.createElement("li"),a=document.createElement("button");a.className="btn-xs btn-danger",a.setAttribute("data-order-id",e.id),a.innerText="remove",a.addEventListener("click",removeFromKart);let n=e.pizza.ingredients.map(e=>e.name).join(", ");e.pizza.name?(t.innerText=`${e.quantity} x ${e.pizza.name} pizza(s) - $${parseFloat(e.total_price).toFixed(2)} `,t.appendChild(a)):(t.innerText=`${e.quantity} x ${e.pizza.size}, ${e.pizza.cut} cut pizza(s) baked ${e.pizza.bake} with ${n} - $${parseFloat(e.total_price).toFixed(2)} `,t.appendChild(a)),r.appendChild(t)}),pageBodyDiv().querySelector("#checkout").addEventListener("click",r=>handleCheckout(r,t,e))}else pageBodyDiv().replaceChild(superMarioSpanGenerator("You have no items in your Kart!"),pageBodyDiv().firstChild)}const removeFromKart=e=>{fetch(`${orderURL}/${e.target.getAttribute("data-order-id")}`,{method:"DELETE"}).then(e=>e.json()).then(t=>{let r=parseFloat(document.querySelector("#total").innerText);r-=parseFloat(t.total_price),document.querySelector("#total").innerText=r,e.target.parentNode.remove(),fetchKartItems()})},handleCheckout=(e,t,r)=>{fetch(`${orderURL}/${currentUser.id}`,{method:"POST",headers:headerObj,body:JSON.stringify({order:t.map(e=>e.id)})}).then(e=>e.json()).then(e=>renderCheckoutDetails(e,r))},renderCheckoutDetails=(e,t)=>{let r=Math.ceil(parseFloat(e[0])),a=e[1].pop().delivery_instructions;pageBodyDiv().innerHTML=`<div class="jumbotron mt-4 bg-dark text-light">\n    <h3 class="display-4">Thank you, ${currentUser.name}!</h3>\n    <p class="lead">Your order total was $${t}. Pizzas take about 25 minutes to prepare.</p>\n    <hr class="my-4 bg-white">\n    <p>The pizza will be delivered to "${currentUser.address}" as per your address and instructions to "${""==a?"N/A":a}". Once prepped, delivery will take ${r} minutes by bike.</p>\n    <img class='gif' src='https://images.beano.com/store/a7b78530ef2b98ec0e2d3916270a6086b68d7a44097d08020828f8baa4e4?auto=compress&w=960&fit=max' />\n    </div>`};function superMarioSpanGenerator(e,t="headerMario"){let r,a=document.createElement("div"),n=e.split(""),o=["blueMario ","greenMario ","yellowMario ","redMario "];return n.forEach(e=>{spn=document.createElement("span");let n=Math.floor(Math.random()*o.length);n===r?(spn.className=o[(n+1)%4]+t,r=(n+1)%4):(spn.className=o[n]+t,r=n),spn.innerText=e,a.appendChild(spn)}),a}